---
layout: post
title: 一致性哈希算法
date: 2025-08-26 17:46:58
categories: 算法
tags:
  - 算法
  - 一致性哈希
  - 编程
  - C++
cover: 'https://pic.akorin.icu/20250826190318220.webp'
codeHeightLimit: 500
toc: true
time_warning: false
end: false
---

# 一致性哈希算法

**一致性哈希（Consistent Hashing）** ：是一种特殊的哈希算法，用于解决 **分布式系统中的数据分布与动态伸缩问题。**

- 当 **节点**（机器/缓存服务器）数量发生变化（增加或减少）时，尽可能减少需要重新映射的数据量。
- 避免传统哈希算法带来的大规模数据迁移问题。

<!-- more -->


## 为什么需要一致性哈希

假设有一个缓存集群：
- 普通哈希方法：`hash(key) % N` （N 是机器数量）。
- 如果某台机器宕机，N 变了 → 所有 key 的分布都变了，几乎所有缓存都会失效，需要重算和迁移。

![](https://pic.akorin.icu/20250826185010124.webp)

## 算法思想

1. 哈希环：把整个哈希值空间想象成一个环。
2. 节点映射：每个机器节点通过哈希映射到环上的一个点。
3. 数据映射：每个数据 key 也映射到环上，顺时针找到第一个节点就是它的存储节点。
4. 节点变化：
    - 新增节点：只影响它顺时针方向的一部分 key。
    - 删除节点：只影响它之前负责的一部分 key。
    ![](https://pic.akorin.icu/20250826214336915.webp)

先通过哈希函数计算出哈希值，落在哈希环上的某个位置，在哈希环中沿着顺时针开始找，直到找到节点。

在上图中，哈希值落在B和C区间，最终都会找到C这个节点。 **删改其中的节点只影响到环上的一部分** ，不会造成服务的大量定位，也就不会出现大量请求突然几种请求某个服务节点。


### 虚拟节点

- 一个物理机器对应多个虚拟节点。
- 虚拟节点均匀分布在哈希环上。
- 这样可以解决部分节点“分到的数据太多”的负载不均衡问题。
  ![](https://pic.akorin.icu/20250826215610930.webp)

在真实的主机，一般会放100~200个虚拟节点。

设置虚拟节点是为了防止物理节点过少，导致哈希处理后， **在一致性哈希环上挤在一块** ，防止导致某一台服务器负载太多，其他服务器一直空闲。



